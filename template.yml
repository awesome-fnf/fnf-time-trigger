ROSTemplateFormatVersion: '2015-09-01'
Transform: 'Aliyun::Serverless-2018-04-03'
Parameters:
  Cron:
    Type: String
    Description: cron expression
    Default: '@every 1m'
  Input:
    Type: String
    Description: target flow json input
    Default: ''
Resources:
  service:
    Type: 'Aliyun::Serverless::Service'
    Properties:
      Description: fnf-time-trigger
      Policies:
        - AliyunFnFFullAccess
    timer:
      Type: 'Aliyun::Serverless::Function'
      Properties:
        FunctionName: timer
        Description: function invoked by FC time trigger
        Handler: timer.handler
        Runtime: python3
        Timeout: 60
        MemorySize: 128
        CodeUri: src/timer.py
      Events:
        trigger:
          DependsOn:
            - flow
          Type: Timer
          Properties:
            Payload:
              'Fn::Replace':
                - <input>:
                    Ref: Input
                  <flow>:
                    'Fn::GetAtt':
                      - flow
                      - Name
                - '{"flow_name": "<flow>", "input": "<input>"}'
            CronExpression:
              'Fn::Replace':
                - <cron>:
                    Ref: Cron
                - <cron>
            Enable: true
    hello:
      Type: 'Aliyun::Serverless::Function'
      Properties:
        FunctionName: hello
        Description: function invoked by FnF flow
        Handler: hello.handler
        Runtime: python3
        Timeout: 60
        MemorySize: 128
        CodeUri: src/hello.py
  flow:
    DependsOn:
      - service
    Type: 'Aliyun::Serverless::Flow'
    Properties:
      Name: time-trigger-demo
      Description: Fnf time trigger demo flow
      Policies:
        - AliyunFCInvocationAccess
      Definition:
        Fn::Replace:
          - <ServiceName>:
              Fn::GetAtt:
                - service
                - ServiceName
          - |-
            version: v1beta1
            type: flow
            steps:
              # task step to invoke FC function hello
              - type: task
                name: hello
                resourceArn: acs:fc:::services/<ServiceName>/functions/hello
